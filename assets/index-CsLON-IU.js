import{initializeApp as e}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";import{getAuth as t,onAuthStateChanged as n,signInAnonymously as r,signInWithCustomToken as i}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";import{collection as a,deleteDoc as o,doc as s,getDoc as c,getFirestore as l,onSnapshot as u,query as d,serverTimestamp as f,setDoc as p}from"https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";(function(){let e=document.createElement(`link`).relList;if(e&&e.supports&&e.supports(`modulepreload`))return;for(let e of document.querySelectorAll(`link[rel="modulepreload"]`))n(e);new MutationObserver(e=>{for(let t of e)if(t.type===`childList`)for(let e of t.addedNodes)e.tagName===`LINK`&&e.rel===`modulepreload`&&n(e)}).observe(document,{childList:!0,subtree:!0});function t(e){let t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),e.crossOrigin===`use-credentials`?t.credentials=`include`:e.crossOrigin===`anonymous`?t.credentials=`omit`:t.credentials=`same-origin`,t}function n(e){if(e.ep)return;e.ep=!0;let n=t(e);fetch(e.href,n)}})();var m=8,h=800,g=`work_entries`,_=`preferences`,v=`settings`,y=[{label:`Tam Gün`,value:`full`},{label:`Yarım Gün`,value:`half`},{label:`Ücretli İzin`,value:`paid_absence`}],b=(typeof __app_id<`u`?__app_id:`default-app-id`).replace(/\//g,`_`),x=typeof __firebase_config<`u`?JSON.parse(__firebase_config):{},S=typeof __initial_auth_token<`u`?__initial_auth_token:null,C=Object.keys(x).length>0,w={db:null,auth:null,userId:null,isAuthReady:!1,hourlyWage:h/m,dailyWageInput:h.toString(),entries:[],currentEntry:{date:new Date().toISOString().split(`T`)[0],status:`full`}},T=e=>new Date(e).toISOString().split(`T`)[0],E=e=>{switch(e){case`full`:case`paid_absence`:return m;case`half`:return m/2;default:return 0}},D=(e,t=`success`)=>{let n=document.getElementById(`message-box`);n.innerHTML=e,n.className=`fixed top-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-xl shadow-lg z-50 transition-all duration-300 ${t===`error`?`bg-red-500`:`bg-green-500`} text-white font-semibold`,n.style.opacity=1,n.style.pointerEvents=`auto`,setTimeout(()=>{n.style.opacity=0,n.style.pointerEvents=`none`},3e3)},O=()=>{document.getElementById(`date-input`).value=w.currentEntry.date,document.getElementById(`daily-wage-input`).value=w.dailyWageInput;let e=w.isAuthReady&&w.userId;document.getElementById(`save-wage-button`).disabled=!e,document.getElementById(`add-entry-button`).disabled=!e;let t=w.hourlyWage*m;document.getElementById(`current-wage-display`).textContent=`${t.toFixed(2)} TL`,document.getElementById(`user-id-display`).textContent=w.userId===`LOCAL_USER_MODE`?`YEREL MOD`:w.userId||`Kimlik Doğrulanıyor...`,C?document.getElementById(`local-mode-alert`).classList.add(`hidden`):document.getElementById(`local-mode-alert`).classList.remove(`hidden`);let n=w.entries.reduce((e,t)=>{let n=t.hourlyWage>0?t.hourlyWage:w.hourlyWage,r=t.duration,i=r*n;return e.totalHours+=r,e.totalPayment+=i,e},{totalHours:0,totalPayment:0});document.getElementById(`total-hours-display`).textContent=`${(n.totalHours/m).toFixed(1)} Gün`,document.getElementById(`total-payment-display`).textContent=`${n.totalPayment.toFixed(2)} TL`,document.getElementById(`entry-count-display`).textContent=w.entries.length;let r=E(w.currentEntry.status);document.getElementById(`entry-payment-display`).textContent=`${(r*w.hourlyWage).toFixed(2)} TL`;let i=document.getElementById(`status-radio-container`);i.innerHTML=y.map(e=>{let t=w.currentEntry.status===e.value;return`
                    <button
                        type="button" 
                        data-status="${e.value}"
                        class="w-full py-3 px-1 text-sm font-semibold rounded-lg border transition duration-150 cursor-pointer text-center 
                        ${t?`bg-blue-600 text-white border-blue-600 shadow-md shadow-blue-300/50`:`bg-gray-100 text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-400`}"
                    >
                        ${e.label}
                    </button>
                `}).join(``),i.onclick=e=>{let t=e.target.closest(`button`);t&&t.dataset.status&&(w.currentEntry.status=t.dataset.status,O())};let a=document.getElementById(`entry-list-container`);w.entries.length===0?a.innerHTML=`<p class="text-center text-gray-500 py-6">Henüz kayıtlı giriş yok.</p>`:(a.innerHTML=w.entries.map(e=>{let t=e.duration,n=t*(e.hourlyWage>0?e.hourlyWage:w.hourlyWage),r=t/m,i=y.find(t=>t.value===e.status)?.label||`Bilinmiyor`,a=e.status===`paid_absence`;return`
                        <div class="flex justify-between items-center py-4 border-b border-gray-100 hover:bg-blue-50/50 transition duration-150 rounded-lg pr-2">
                            <div class="flex items-center flex-1 min-w-0 ml-2">
                                <svg class="w-5 h-5 text-blue-500 mr-3 hidden sm:block" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/></svg>
                                <div class="flex flex-col">
                                    <p class="text-base font-semibold text-gray-800 truncate">${e.date}</p>
                                    <p class="text-xs font-medium ${a?`text-purple-500`:`text-gray-500`}">${i}</p>
                                </div>
                            </div>
                            <div class="flex flex-col items-end mr-4">
                                <p class="text-base font-bold text-green-600">${r.toFixed(1)} Gün</p>
                                <p class="text-sm font-medium text-gray-700">${n.toFixed(2)} TL</p>
                            </div>
                            <button 
                                data-id="${e.id}"
                                class="delete-btn p-2 bg-red-100 text-red-600 rounded-full hover:bg-red-200 transition duration-150 shadow-sm"
                                title="Kaydı Sil"
                            >
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></svg>
                            </button>
                        </div>
                    `}).join(``),a.querySelectorAll(`.delete-btn`).forEach(e=>{e.onclick=e=>P(e.currentTarget.dataset.id)}));let o=document.getElementById(`work-chart-bars`),s=[...w.entries].sort((e,t)=>new Date(e.date)-new Date(t.date)).slice(-7);if(s.length===0){o.innerHTML=`<p class="text-center text-gray-500 py-4 text-sm">Görüntülenecek yeterli kayıt yok (Min. 1).</p>`;return}let c=m/m,l=new Date;l.setHours(0,0,0,0),o.innerHTML=`<div class="flex justify-between items-end h-32 space-x-2 border-b border-gray-200 pt-4">
                ${s.map((e,t)=>{let n=e.duration/m,r=n/c*100,i=``,a=new Date(e.date+`T00:00:00`);return i=a.getTime()===l.getTime()?`Bugün`:a.toLocaleDateString(`tr-TR`,{day:`numeric`,month:`short`}),`
                        <div class="flex flex-col items-center h-full flex-1 min-w-[30px] group">
                            <div 
                                class="w-full bg-blue-600 rounded-t-md transition-all duration-500 hover:bg-blue-400 relative"
                                style="height: ${Math.max(1,r)}%;"
                                title="${e.date}: ${n.toFixed(1)} Gün"
                            >
                                <span class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-xs font-semibold text-gray-700 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
                                    ${n.toFixed(1)}
                                </span>
                            </div>
                            <span class="mt-1 text-xs text-gray-500 font-medium whitespace-nowrap overflow-hidden text-ellipsis max-w-full">
                                ${i}
                            </span>
                        </div>
                    `}).join(``)}
            </div>
            <p class="text-right text-xs text-gray-400 mt-2">Maksimum: 1 Tam Gün</p>`},k=async()=>{if(!(!w.db||!w.userId||!C))try{let e=await c(s(w.db,`/artifacts/${b}/users/${w.userId}/${_}`,v));if(e.exists()){let t=e.data();t.hourlyWage&&typeof t.hourlyWage==`number`&&(w.hourlyWage=t.hourlyWage,w.dailyWageInput=(t.hourlyWage*m).toString(),O())}}catch(e){console.error(`Ücret ayarı yüklenirken hata:`,e)}},A=()=>{if(!w.db||!w.userId||!C)return;let e=`/artifacts/${b}/users/${w.userId}/${g}`;u(d(a(w.db,e)),e=>{let t=e.docs.map(e=>{let t=e.data(),n=t.duration||E(t.status);return{id:e.id,...t,duration:n,hourlyWage:t.hourlyWage||w.hourlyWage}});t.sort((e,t)=>new Date(t.date)-new Date(e.date)),w.entries=t,O()},e=>{console.error(`Firestore veri dinleme hatası:`,e),D(`Veri yüklenirken bir hata oluştu.`,`error`)})},j=async()=>{if(!C){console.error(`Firebase Yapılandırması Boş. Uygulama Yerel Modda Başlatılıyor.`),D(`Veritabanı bağlantısı kurulamadı. Uygulama sadece yerel (geçici) simülasyon modunda çalışacaktır.`,`error`),w.userId=`LOCAL_USER_MODE`,w.isAuthReady=!0,O();return}try{let a=e(x);w.db=l(a),w.auth=t(a),S?await i(w.auth,S):await r(w.auth),n(w.auth,e=>{e?(w.userId=e.uid,k(),A()):w.userId=null,w.isAuthReady=!0,O()})}catch(e){console.error(`Firebase başlatma hatası:`,e),D(`Uygulama başlatılırken kritik hata oluştu.`,`error`),w.isAuthReady=!0,O()}},M=async()=>{let e=parseFloat(document.getElementById(`daily-wage-input`).value);if(isNaN(e)||e<=0){D(`Lütfen geçerli bir pozitif sayı (günlük tam ücret) girin. (Örn: 900)`,`error`);return}let t=e/m;if(w.hourlyWage=t,w.dailyWageInput=e.toString(),O(),!w.db||!w.userId||w.userId===`LOCAL_USER_MODE`){D(`Günlük Tam Ücret ${e.toFixed(2)} TL olarak YEREL olarak ayarlandı. Veritabanına kaydedilemedi.`,`error`);return}try{await p(s(w.db,`/artifacts/${b}/users/${w.userId}/${_}`,v),{hourlyWage:t},{merge:!0}),D(`Günlük Tam Ücret ${e.toFixed(2)} TL olarak kaydedildi.`)}catch(e){console.error(`Ücret ayarı kaydedilirken hata:`,e),D(`Ücret kaydedilemedi. Konsolu kontrol edin.`,`error`)}},N=async()=>{let e=document.getElementById(`date-input`).value,t=w.currentEntry.status;if(!e||!t){D(`Lütfen Tarih ve Çalışma Durumu alanlarını doldurun.`,`error`);return}let n=E(t),r=T(e),i={id:r,date:e,status:t,duration:n,hourlyWage:w.hourlyWage,createdAt:f()};if(w.entries.some(e=>e.id===r)){D(`Bu tarihe ait zaten bir kayıt var. Lütfen önce mevcut kaydı silin.`,`error`);return}if(!w.db||!w.userId||w.userId===`LOCAL_USER_MODE`){w.entries=[...w.entries,i],w.entries.sort((e,t)=>new Date(t.date)-new Date(e.date)),w.currentEntry.date=new Date().toISOString().split(`T`)[0],O(),D(`Giriş YEREL olarak eklendi. Veritabanına kaydedilemedi.`,`error`);return}try{await p(s(a(w.db,`/artifacts/${b}/users/${w.userId}/${g}`),r),i,{merge:!1}),w.currentEntry.date=new Date().toISOString().split(`T`)[0],O(),D(`Giriş başarıyla eklendi.`)}catch(e){console.error(`Giriş eklenirken hata oluştu:`,e),D(`Giriş eklenirken bir hata oluştu.`,`error`)}},P=async e=>{if(!w.db||!w.userId||w.userId===`LOCAL_USER_MODE`){w.entries=w.entries.filter(t=>t.id!==e),O(),D(`Giriş YEREL olarak silindi. Veritabanı bağlantısı yok.`,`error`);return}try{await o(s(w.db,`/artifacts/${b}/users/${w.userId}/${g}`,e)),D(`Giriş başarıyla silindi.`,`success`)}catch(e){console.error(`Giriş silinirken hata oluştu:`,e),D(`Giriş silinirken bir hata oluştu. Lütfen konsolu kontrol edin.`,`error`)}};document.addEventListener(`DOMContentLoaded`,()=>{let e=document.getElementById(`date-input`),t=document.getElementById(`daily-wage-input`);e.value=w.currentEntry.date,e.onchange=e=>{w.currentEntry.date=e.target.value},t.oninput=e=>{w.dailyWageInput=e.target.value},document.getElementById(`save-wage-button`).onclick=M,document.getElementById(`add-entry-button`).onclick=N,j(),O()});